// Curated playlist database with mood mappings
export const playlistDatabase = {
  Gloomy: [
    {
      id: '37i9dQZF1DX7qK8ma5wgG1',
      name: 'Sad Songs',
      description: 'Beautiful songs to help you feel understood',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000034e75c14c6c0874d8ca53ee7c',
      energy: 3,
      tempo: 'slow',
      valence: 2,
      genres: ['indie', 'acoustic', 'sad']
    },
    {
      id: '37i9dQZF1DWZqdNJKp6peI',
      name: 'Melancholic Instrumental',
      description: 'Soulful instrumental pieces for reflection',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003e435ce0a86a8b9dc24527618',
      energy: 2,
      tempo: 'slow',
      valence: 3,
      genres: ['classical', 'instrumental', 'ambient']
    },
    {
      id: '37i9dQZF1DX3YSRoSdA634',
      name: 'Life Sucks',
      description: 'Having a bad day? We know how it feels.',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000035ae7aa0454c9eafdd454cb25',
      energy: 4,
      tempo: 'medium',
      valence: 2,
      genres: ['rock', 'alternative', 'grunge']
    },
    {
      id: '37i9dQZF1DWX83CujKHHOn',
      name: 'Alone Again',
      description: 'Songs for when you need some alone time.',
      imageUrl: 'https://i.scdn.co/image/ab67706f0000000317f5f19c170db3f7c5be4ab9',
      energy: 3,
      tempo: 'slow',
      valence: 2,
      genres: ['indie', 'folk', 'acoustic']
    },
    {
      id: '37i9dQZF1DWYxwmBaMqxsl',
      name: 'Rainy Day Jazz',
      description: 'Melancholic jazz for rainy days',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003e4124e03527d12d1f65af0d9',
      energy: 2,
      tempo: 'slow',
      valence: 3,
      genres: ['jazz', 'blues', 'instrumental']
    },
    {
      id: '37i9dQZF1DX59HcpGmPXYR',
      name: 'Heartache',
      description: 'Songs for healing a broken heart',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003e31a2ef3d75501c3f3835f6b',
      energy: 3,
      tempo: 'slow',
      valence: 2,
      genres: ['pop', 'ballad', 'soul']
    },
    {
      id: '37i9dQZF1DWUNIrSzKgQbP',
      name: 'Dark & Stormy',
      description: 'Moody alternative and rock tracks',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003134324e26add3a4fba3ab36c',
      energy: 5,
      tempo: 'medium',
      valence: 2,
      genres: ['alternative', 'rock', 'indie']
    },
    {
      id: '37i9dQZF1DWZd79rJ6a7lp',
      name: 'Sleep',
      description: 'Gentle ambient sounds for rest',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003b70e0223f544b1faa2e95ed0',
      energy: 1,
      tempo: 'very-slow',
      valence: 3,
      genres: ['ambient', 'sleep', 'instrumental']
    },
    {
      id: '37i9dQZF1DX6xZZEgC9Ubl',
      name: 'Acoustic Ballads',
      description: 'Stripped-down versions of emotional songs',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003ca5a7517156021c57124c001',
      energy: 2,
      tempo: 'slow',
      valence: 3,
      genres: ['acoustic', 'folk', 'indie']
    },
    {
      id: '37i9dQZF1DX4sWSpwq3LiO',
      name: 'Peaceful Piano',
      description: 'Relax and indulge with beautiful piano pieces',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003ca5a7517156021c57124c001',
      energy: 2,
      tempo: 'slow',
      valence: 3,
      genres: ['classical', 'piano', 'instrumental']
    }
  ],
  Mellow: [
    {
      id: '37i9dQZF1DX4WYpdgoIcn6',
      name: 'Chill Hits',
      description: 'Kick back to the best new and recent chill hits',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003c179c64c2589a74e83f32f4f',
      energy: 5,
      tempo: 'medium',
      valence: 6,
      genres: ['pop', 'indie', 'electronic']
    },
    {
      id: '37i9dQZF1DWWQRwui0ExPn',
      name: 'Lofi Beats',
      description: 'The chillest beats to help you relax',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003f4b0a4b12d2f82f2a8281e75',
      energy: 4,
      tempo: 'medium',
      valence: 5,
      genres: ['lofi', 'instrumental', 'beats']
    },
    {
      id: '37i9dQZF1DX0MLFaUdXnjA',
      name: 'Peaceful Piano',
      description: 'Peaceful piano to help you slow down.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003ca5a7517156021c57124c001',
      energy: 2,
      tempo: 'slow',
      valence: 5,
      genres: ['piano', 'classical', 'instrumental']
    },
    {
      id: '37i9dQZF1DXcCnTAt8CfNe',
      name: 'Acoustic Covers',
      description: 'Stripped down versions of your favorite songs.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003df7e498bea00b5e4787c1cae',
      energy: 3,
      tempo: 'medium',
      valence: 6,
      genres: ['acoustic', 'covers', 'indie']
    },
    {
      id: '37i9dQZF1DX889U0CL85jj',
      name: 'Coffee + Chill',
      description: 'Gentle acoustic music to sip your coffee to.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003e7a398c48af8518c25f8962e',
      energy: 3,
      tempo: 'slow',
      valence: 6,
      genres: ['acoustic', 'folk', 'indie']
    },
    {
      id: '37i9dQZF1DX4E3UdUs7fUx',
      name: 'Beach Vibes',
      description: 'Laid-back summer tunes',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003c1d2f3c8a7d6c8f836552f64',
      energy: 4,
      tempo: 'medium',
      valence: 7,
      genres: ['indie', 'surf', 'pop']
    },
    {
      id: '37i9dQZF1DXcZDD7cfEKhW',
      name: 'Pop Study',
      description: 'Chill pop music to help you study',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003d4daf27fe84c0a8b4f6c1cec',
      energy: 4,
      tempo: 'medium',
      valence: 6,
      genres: ['pop', 'study', 'focus']
    },
    {
      id: '37i9dQZF1DX0jgyAiPl8Af',
      name: 'Soft Pop Hits',
      description: 'Listen to easy songs from your favorite artists',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000034856d68c6c32a4e3f12d09f8',
      energy: 5,
      tempo: 'medium',
      valence: 7,
      genres: ['pop', 'soft', 'hits']
    },
    {
      id: '37i9dQZF1DWTwnEm1IYyoj',
      name: 'Soft Instrumental',
      description: 'Peaceful instrumental background music',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000036014b3a18a82d59aee097c1c',
      energy: 3,
      tempo: 'slow',
      valence: 6,
      genres: ['instrumental', 'ambient', 'classical']
    },
    {
      id: '37i9dQZF1DX6VdMW310YC7',
      name: 'Chill Tracks',
      description: 'Softer kinda dance',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003ec1c5c32e52a59c3f2e94dde',
      energy: 4,
      tempo: 'medium',
      valence: 6,
      genres: ['electronic', 'chill', 'dance']
    }
  ],
  'Slow but Moving': [
    {
      id: '37i9dQZF1DX9B1hu73DioC',
      name: 'Motivation Mix',
      description: 'Uplifting songs to keep you moving forward',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000039249b35f23fb596b6f006a15',
      energy: 7,
      tempo: 'medium-fast',
      valence: 7,
      genres: ['pop', 'rock', 'indie']
    },
    {
      id: '37i9dQZF1DXdxcBWuJkbcy',
      name: 'Uplifting Indie',
      description: 'Feel-good indie tracks',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003e9c9c4c10f6227e98f4b6edd',
      energy: 6,
      tempo: 'medium',
      valence: 8,
      genres: ['indie', 'alternative', 'folk']
    },
    {
      id: '37i9dQZF1DWSqmBTGDYngZ',
      name: 'Morning Motivation',
      description: 'Upbeat instrumental music to get you going.',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000034d26d431869cabfc53c67d8e',
      energy: 6,
      tempo: 'medium',
      valence: 7,
      genres: ['instrumental', 'electronic', 'ambient']
    },
    {
      id: '37i9dQZF1DWTkxQvqMy4WW',
      name: 'Sunny Beats',
      description: 'Bright, optimistic instrumental beats.',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000036e1034ebd7b7c86546c6acca',
      energy: 5,
      tempo: 'medium',
      valence: 8,
      genres: ['electronic', 'beats', 'chill']
    },
    {
      id: '37i9dQZF1DWUvQoIOFMFUT',
      name: 'Calming Acoustic',
      description: 'Gentle acoustic tracks to lift your spirits.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003e4b3113091f3f17730bd462e',
      energy: 4,
      tempo: 'medium',
      valence: 7,
      genres: ['acoustic', 'folk', 'indie']
    },
    {
      id: '37i9dQZF1DX1OY2Lp0bIPp',
      name: 'Monday Motivation',
      description: 'Start your week with these motivational hits',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000033f861d7f7b24921b6d401352',
      energy: 7,
      tempo: 'medium-fast',
      valence: 8,
      genres: ['pop', 'rock', 'motivation']
    },
    {
      id: '37i9dQZF1DWUa8ZRTfalHk',
      name: 'Rise Up',
      description: 'Songs to inspire and uplift',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003b6aa61c0e5f45eb875154387',
      energy: 6,
      tempo: 'medium',
      valence: 8,
      genres: ['pop', 'soul', 'gospel']
    },
    {
      id: '37i9dQZF1DX4fpCWaHOned',
      name: 'Confidence Boost',
      description: 'Music to boost your confidence',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000034856d68c6c32a4e3f12d09f8',
      energy: 7,
      tempo: 'medium-fast',
      valence: 8,
      genres: ['pop', 'hip-hop', 'r&b']
    },
    {
      id: '37i9dQZF1DX1g0iEXLFycr',
      name: 'Positive Vibes',
      description: 'Uplifting and positive music',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003bd0e19e810bb4b55ab164a95',
      energy: 6,
      tempo: 'medium',
      valence: 8,
      genres: ['pop', 'indie', 'folk']
    },
    {
      id: '37i9dQZF1DX9XIFQuFvzM4',
      name: 'Feelin\' Good',
      description: 'Feel-good music for feel-good times!',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003c0f42671f7aa9d3ee2c3fb82',
      energy: 7,
      tempo: 'medium-fast',
      valence: 8,
      genres: ['pop', 'funk', 'soul']
    }
  ],
  Radiant: [
    {
      id: '37i9dQZF1DXdPec7aLTmlC',
      name: 'Happy Hits',
      description: 'Hits to make you smile!',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003bd0e19e810bb4b55ab164a95',
      energy: 9,
      tempo: 'fast',
      valence: 9,
      genres: ['pop', 'dance', 'electronic']
    },
    {
      id: '37i9dQZF1DX3rxVfibe1L0',
      name: 'Mood Booster',
      description: 'Get happy with today\'s dose of feel-good songs!',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003bd0e19e810bb4b55ab164a95',
      energy: 8,
      tempo: 'fast',
      valence: 9,
      genres: ['pop', 'dance', 'hits']
    },
    {
      id: '37i9dQZF1DX9XIFQuFvzM4',
      name: 'Feelin\' Good',
      description: 'Feel-good music for feel-good times!',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003c0f42671f7aa9d3ee2c3fb82',
      energy: 8,
      tempo: 'medium-fast',
      valence: 9,
      genres: ['pop', 'funk', 'soul']
    },
    {
      id: '37i9dQZF1DX0UrRvztWcAU',
      name: 'Dance Party',
      description: 'Upbeat dance hits that\'ll make you move!',
      imageUrl: 'https://i.scdn.co/image/ab67706f0000000318e20d8d2bc7aa007d305e57',
      energy: 9,
      tempo: 'fast',
      valence: 8,
      genres: ['dance', 'electronic', 'pop']
    },
    {
      id: '37i9dQZF1DX7KNKjOK0o75',
      name: 'Have a Great Day!',
      description: 'Feel-good songs for feel-good moments.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003fe0099a8dcd3054706f32f7c',
      energy: 7,
      tempo: 'medium-fast',
      valence: 9,
      genres: ['pop', 'rock', 'indie']
    },
    {
      id: '37i9dQZF1DX2SK4uqvIZ4J',
      name: 'Happiness Hits',
      description: 'The happiest songs to brighten your day',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003bd0e19e810bb4b55ab164a95',
      energy: 8,
      tempo: 'fast',
      valence: 9,
      genres: ['pop', 'dance', 'electronic']
    },
    {
      id: '37i9dQZF1DX3ZeFHRhhi7Y',
      name: 'Joyful Beats',
      description: 'Upbeat electronic music to lift your spirits',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000036e1034ebd7b7c86546c6acca',
      energy: 8,
      tempo: 'fast',
      valence: 9,
      genres: ['electronic', 'dance', 'pop']
    },
    {
      id: '37i9dQZF1DX9T8P5EZYYhU',
      name: 'Summer Party',
      description: 'The perfect summer playlist!',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003c1d2f3c8a7d6c8f836552f64',
      energy: 9,
      tempo: 'fast',
      valence: 9,
      genres: ['pop', 'dance', 'summer']
    },
    {
      id: '37i9dQZF1DX7KPeXPDG4GB',
      name: 'Good Energy',
      description: 'Positive vibes and upbeat tunes',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003fe0099a8dcd3054706f32f7c',
      energy: 8,
      tempo: 'medium-fast',
      valence: 9,
      genres: ['pop', 'indie', 'electronic']
    },
    {
      id: '37i9dQZF1DXdSjVZQzv2tl',
      name: 'Pure Joy',
      description: 'Songs that spark pure happiness',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003bd0e19e810bb4b55ab164a95',
      energy: 8,
      tempo: 'fast',
      valence: 9,
      genres: ['pop', 'indie', 'electronic']
    }
  ],
  Neutral: [
    {
      id: '37i9dQZF1DWWQRwui0ExPn',
      name: 'Deep Focus',
      description: 'Keep calm and focus with ambient and post-rock music.',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000036014b3a18a82d59aee097c1c',
      energy: 5,
      tempo: 'medium',
      valence: 5,
      genres: ['ambient', 'instrumental', 'focus']
    },
    {
      id: '37i9dQZF1DX3Ogo9pFvBkY',
      name: 'Ambient Essentials',
      description: 'Gentle ambient tracks to help you stay centered.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003c0c5bb00461fd08b95f9f187',
      energy: 4,
      tempo: 'slow',
      valence: 5,
      genres: ['ambient', 'electronic', 'meditation']
    },
    {
      id: '37i9dQZF1DWZeKCadgRdKQ',
      name: 'White Noise',
      description: 'Soothing sounds and white noise for focus.',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000035f4c9262d1eb3b4d326c2a1f',
      energy: 3,
      tempo: 'slow',
      valence: 5,
      genres: ['ambient', 'noise', 'focus']
    },
    {
      id: '37i9dQZF1DX1s9knjP51Oa',
      name: 'Calm Vibes',
      description: 'Calm electronic music for any situation.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003a6e2870c97bde5e2719c20b8',
      energy: 4,
      tempo: 'medium',
      valence: 6,
      genres: ['electronic', 'ambient', 'chill']
    },
    {
      id: '37i9dQZF1DX5trt9i14X7j',
      name: 'Coding Mode',
      description: 'Dedicated to all the programmers out there.',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003863b311d4b787ed621f7e696',
      energy: 5,
      tempo: 'medium',
      valence: 5,
      genres: ['electronic', 'ambient', 'focus']
    },
    {
      id: '37i9dQZF1DX4sWSpwq3LiO',
      name: 'Peaceful Piano',
      description: 'Relax and indulge with beautiful piano pieces',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003ca5a7517156021c57124c001',
      energy: 2,
      tempo: 'slow',
      valence: 5,
      genres: ['classical', 'piano', 'instrumental']
    },
    {
      id: '37i9dQZF1DX35X4JNyBWtb',
      name: 'Nature Sounds',
      description: 'Calming nature sounds for relaxation',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003e435ce0a86a8b9dc24527618',
      energy: 2,
      tempo: 'slow',
      valence: 5,
      genres: ['nature', 'ambient', 'meditation']
    },
    {
      id: '37i9dQZF1DWZqd5JICZI0u',
      name: 'Peaceful Meditation',
      description: 'Peaceful ambient for meditation',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000036014b3a18a82d59aee097c1c',
      energy: 2,
      tempo: 'slow',
      valence: 5,
      genres: ['meditation', 'ambient', 'instrumental']
    },
    {
      id: '37i9dQZF1DX9uKNf5jGX6m',
      name: 'Study Zone',
      description: 'Instrumental study music',
      imageUrl: 'https://i.scdn.co/image/ab67706f00000003d4daf27fe84c0a8b4f6c1cec',
      energy: 4,
      tempo: 'medium',
      valence: 5,
      genres: ['study', 'focus', 'instrumental']
    },
    {
      id: '37i9dQZF1DX8Uebhn9wzrS',
      name: 'Chill Lofi Study Beats',
      description: 'The perfect study beats, twenty four seven.',
      imageUrl: 'https://i.scdn.co/image/ab67706f000000036014b3a18a82d59aee097c1c',
      energy: 4,
      tempo: 'medium',
      valence: 5,
      genres: ['lofi', 'study', 'beats']
    }
  ]
};

// Playlist rotation tracking
const PLAYLIST_HISTORY_KEY = 'playlist-rotation-history';

interface PlaylistHistory {
  [mood: string]: {
    lastPlayed: number;
    playCount: number;
    id: string;
  }[];
}

function getPlaylistHistory(): PlaylistHistory {
  const history = localStorage.getItem(PLAYLIST_HISTORY_KEY);
  return history ? JSON.parse(history) : {};
}

function savePlaylistHistory(history: PlaylistHistory) {
  localStorage.setItem(PLAYLIST_HISTORY_KEY, JSON.stringify(history));
}

let lastSelectedPlaylist: string | null = null;

export function getPlaylistForMood(mood: keyof typeof playlistDatabase | null): typeof playlistDatabase[keyof typeof playlistDatabase][0] {
  // If mood is null or not found in database, use Neutral category
  const effectiveMood = (mood && mood in playlistDatabase) ? mood : 'Neutral';
  const playlists = playlistDatabase[effectiveMood];
  const history = getPlaylistHistory();

  // Initialize mood history if it doesn't exist
  if (!history[effectiveMood]) {
    history[effectiveMood] = [];
  }

  // Sort playlists by play count and last played time
  const sortedPlaylists = playlists.map(playlist => {
    const historyEntry = history[effectiveMood].find(h => h.id === playlist.id);
    return {
      ...playlist,
      lastPlayed: historyEntry?.lastPlayed || 0,
      playCount: historyEntry?.playCount || 0
    };
  }).sort((a, b) => {
    // First, prioritize less played playlists
    if (a.playCount !== b.playCount) {
      return a.playCount - b.playCount;
    }
    // Then prioritize playlists that haven't been played recently
    return a.lastPlayed - b.lastPlayed;
  });

  // Filter out the last selected playlist to avoid immediate repeats
  const availablePlaylists = sortedPlaylists.filter(p => p.id !== lastSelectedPlaylist);
  
  // If all playlists have been played, reset history for this mood
  if (availablePlaylists.length === 0) {
    history[effectiveMood] = [];
    lastSelectedPlaylist = null;
    return getPlaylistForMood(mood); // Recursive call with clean history
  }

  // Get the least played/oldest playlist
  const selectedPlaylist = availablePlaylists[0];
  lastSelectedPlaylist = selectedPlaylist.id;

  // Update history for the selected playlist
  const now = Date.now();
  const existingEntryIndex = history[effectiveMood].findIndex(h => h.id === selectedPlaylist.id);

  if (existingEntryIndex !== -1) {
    // Update existing entry
    history[effectiveMood][existingEntryIndex] = {
      id: selectedPlaylist.id,
      lastPlayed: now,
      playCount: history[effectiveMood][existingEntryIndex].playCount + 1
    };
  } else {
    // Add new entry
    history[effectiveMood].push({
      id: selectedPlaylist.id,
      lastPlayed: now,
      playCount: 1
    });
  }

  // Keep history size manageable
  if (history[effectiveMood].length > playlists.length) {
    // Remove entries for playlists that haven't been played in a while
    const oldestAllowed = now - (7 * 24 * 60 * 60 * 1000); // 7 days
    history[effectiveMood] = history[effectiveMood].filter(h => h.lastPlayed > oldestAllowed);
  }

  savePlaylistHistory(history);

  // Return the selected playlist without the tracking properties
  const { lastPlayed, playCount, ...cleanPlaylist } = selectedPlaylist;
  return cleanPlaylist;
}